# MyWebServer

## 功能 
`copy from markparticle/WebServer`
* 利用IO复用技术Epoll与线程池实现多线程的Reactor高并发模型；
* 利用正则与状态机解析HTTP请求报文，实现处理静态资源的请求；
* 利用标准库容器封装char，实现自动增长的缓冲区；
* 基于小根堆实现的定时器，关闭超时的非活动连接；
* 利用单例模式与阻塞队列实现异步的日志系统，记录服务器运行状态；
* 利用RAII机制实现了数据库连接池，减少数据库连接建立与关闭的开销，同时实现了用户注册登录功能
## 模块组成

### 请求监听模块
#### Epoller类

1. 负责监听客户端连接请求和读写请求，ET模式+非阻塞
2. 负责在Epoll监听红黑树上添加、修改、删除被监听的文件描述符

**监听流程的逻辑梳理：** 服务器类先初始化，创建epoll类并监听listenFd。如果来的是客户端连接请求，就新建立一条客户端连接类，对数据的读取和对业务的处理都是由这个连接类完成的。如果来的是读请求或写请求，就把任务（任务是由一个回调函数构成的）加入到请求队列，由工作线程来处理。HttpConn类非常关键，他是用来连接服务器和线程池的。IO和业务流程都是针对于某一条连接的执行的。
### http请求处理模块

#### HttpConn类
1. 将每个客户端连接抽象成一个`HttpConn`类
2. 对每个`HttpConn`对象进行数据读写操作、Http请求报文的解析、Http响应报文的构造

#### HttpRequest类
1. 对请求报文进行解析
   * GET请求：请求行（方法名 资源路径 Http版本号）、请求头、空行、请求体（GET请求为空）
   * POST请求：请求行（方法名 资源路径 Http版本号）、请求头、空行、请求体。
2. 处理用户登录请求和注册请求，成功或失败都返回不同的资源

**请求处理逻辑梳理：** 利用状态机，一开始的状态是读请求行，将请求行的请求方法、请求资源路径、http版本号存下来。接着读请求头，一行一行读，每个请求头是由键值对组成的。读到空行，如果空行后面没有数据，那么表示是GET请求，直接退出状态机，否则是POST请求，解析请求体。我们这里只讨论对 **表单提交** 的数据进行解析，将每个键值对也解析出来。

#### HttpResponse类
1. 基于解析完成的请求报文，生成响应报文：状态行（Http版本 状态码 状态信息）、响应头、空号、响应正文

**生成响应报文的流程：** 响应报文的组成有状态行、响应头、空行、响应体。状态行组成：http版本、状态码、状态消息。响应头组成：Content-Type、Connection

### 线程池
#### ThreadPool类
1. 预先创建多个工作线程，用于处理指定的任务
2. 维护一个请求队列，用于存放需要处理的任务
3. 多线程对请求队列进行互斥访问，通过条件变量来满足生产者消费者模型
### 数据库连接池
#### SqlConnPool类
1. 预先创建多个数据库连接，对指定的数据库表进行访问
2. 通过互斥量和信号量来对连接池队列进行访问
#### SqlConnRAII类
1. 利用RAII机制，来管理数据库连接对象资源
### 自定义缓冲区
#### Buffer类
1. 利用`vector`容器封装`char` 实现自动增长的缓冲区

**缓冲区逻辑梳理：** 首先创建缓冲区，用`vector`容器存数据；接着就是读取数据`iovec`结构体和`readv`系统调用配合，读取数据到多个缓冲区，如果数据超出当前剩余可写的空间，就进行扩容或者整理内碎片。然后再将超出的数据写入缓冲区。

### 超时定时器
#### Timer类
1. 基于小根堆实现的定时器，关闭超时的非活动连接
### 日志系统
#### Log类
1. 单例模式设计
2. 实现对日志文件的异步和同步写入
3. 同步写入：生成日志内容就直接调用`fputs`写入。异步写入：生成日志内容先插入阻塞队列，由写线程进行写入

**日志系统逻辑梳理：** 同时具备同步和异步写日志的功能，**对于同步日志**，直接调用fputs函数写入日志文件即可，**对于异步写**，需要实现一个阻塞队列，用来存需要写入日志文件的内容，内容的获取和添加需要满足生产者消费者模型。然后是**日志类的实现**，单例模式，首先对日志类进行初始化，初始化阻塞队列，写日志子线程，创建日志文件。对于写日志，需要获得当前的时间信息，判断是否需要生成新的日志文件继续写，然后开始构造需要写的日志内容，并把内容插入到阻塞队列。然后写日志子线程的作用就是从阻塞队列中取出内容写入日志文件。
#### BlockQueue类
1. 对于日志异步写入，需要维护一个阻塞队列。
2. 由写线程对阻塞队列进行互斥访问，将内容写入日志。


## TODO
* 模块的单元测试
* 模块的实现思路总结
* 模块的新知识点总结
* 面试题的知识点扩展